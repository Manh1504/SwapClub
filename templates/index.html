<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <title>Swap đồ cũ</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQHKusq-Pr6zfkBGeB7ibDfdZlZddYeAY",
      authDomain: "swap-ba42e.firebaseapp.com",
      projectId: "swap-ba42e",
      storageBucket: "swap-ba42e.appspot.com",
      messagingSenderId: "1019527124876",
      appId: "1:1019527124876:web:a669f2f02a60695b77e8a9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    let currentUser = null;

    window.login = () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
        .then(result => {
          currentUser = result.user;
          alert("Đăng nhập thành công: " + currentUser.email);
        })
        .catch(error => {
          console.error(error);
          alert("Lỗi đăng nhập");
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('product-form');
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        if (!currentUser) return alert("Bạn cần đăng nhập trước");

        const idToken = await currentUser.getIdToken();

        fetch('/api/products', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + idToken
          },
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          alert("Đăng bài thành công!");
          form.reset();
          loadProducts();
        });
      });

      function loadProducts() {
        fetch('/api/products')
          .then(res => res.json())
          .then(data => {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            for (let id in data) {
              const p = data[id];
              list.innerHTML += `<div><h3>${p.name}</h3><img src="${p.image_url}" width="150"><p>${p.description}</p><hr></div>`;
            }
          });
      }

      loadProducts();
    });
  </script>
</head>
<body>
  <h1>Đăng bài pass đồ</h1>
  <button onclick="login()">Đăng nhập bằng Google</button>
  <form id="product-form">
    <input type="text" name="name" placeholder="Tên đồ dùng" required><br>
    <textarea name="description" placeholder="Mô tả"></textarea><br>
    <input type="file" name="image" accept="image/*" required><br>
    <button type="submit">Đăng bài</button>
  </form>
  <div id="product-list"></div>
</body>
</html>
