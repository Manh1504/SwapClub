{% extends "base.html" %}

{% block title %}{{ product.name }} - Chợ Đồ Cũ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css">
<style>
    .seller-info {
        border-left: 1px solid #dee2e6;
        height: 100%;
    }
    
    .price-tag {
        font-size: 1.8rem;
        font-weight: bold;
        color: #e74c3c;
    }
    
    .product-meta {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .product-actions {
        margin-top: 20px;
    }
    
    .thumbnail-container {
        display: flex;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    
    .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin-right: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        border-radius: 4px;
        border: 2px solid transparent;
    }
    
    .thumbnail.active {
        border-color: #007bff;
    }
    
    .message-seller-form {
        margin-top: 20px;
    }
    
    .seller-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .rating {
        color: #ffc107;
    }
    
    .similar-product {
        height: 100%;
    }
    
    .similar-img {
        height: 150px;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('products.list', category=product.category) }}">{{ product.category }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>
    
    <div class="row mb-4">
        <!-- Hình ảnh sản phẩm -->
        <div class="col-md-6">
            <div class="product-image-container mb-2">
                <a href="{{ product.images[0] }}" data-fancybox="gallery" data-caption="{{ product.name }}">
                    <img src="{{ product.images[0] }}" alt="{{ product.name }}" id="main-image" class="product-image img-fluid rounded">
                </a>
            </div>
            
            <div class="thumbnail-container">
                {% for image in product.images %}
                    <img src="{{ image }}" 
                         alt="{{ product.name }} - Ảnh {{ loop.index }}" 
                         class="thumbnail {% if loop.first %}active{% endif %}"
                         data-img-url="{{ image }}"
                         onclick="changeMainImage(this)">
                {% endfor %}
            </div>
        </div>
        
        <!-- Thông tin sản phẩm -->
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-8">
                    <h2>{{ product.name }}</h2>
                    <div class="price-tag mb-3">
                        {{ "{:,.0f}".format(product.price) }} đ
                        {% if product.negotiable %}
                            <span class="badge bg-info ms-2">Có thể thương lượng</span>
                        {% endif %}
                    </div>
                    
                    <div class="product-meta mb-3">
                        <p><strong>Tình trạng:</strong> {{ product.condition }}</p>
                        <p><strong>Danh mục:</strong> <a href="{{ url_for('products.list', category=product.category) }}">{{ product.category }}</a></p>
                        <p><strong>Địa điểm:</strong> {{ product.location }}</p>
                        <p><strong>Đăng ngày:</strong> {{ product.created_at.strftime('%d/%m/%Y') }}</p>
                        <p><strong>Lượt xem:</strong> {{ product.views }}</p>
                    </div>
                    
                    <div class="product-actions">
                        {% if current_user.is_authenticated and current_user.id != product.seller_id %}
                            <a href="{{ url_for('orders.checkout', product_id=product.id) }}" class="btn btn-primary">
                                <i class="fas fa-shopping-cart me-2"></i>Mua ngay
                            </a>
                            <button class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#messageForm">
                                <i class="fas fa-comment me-2"></i>Liên hệ người bán
                            </button>
                            <button class="btn btn-outline-danger" onclick="toggleFavorite({{ product.id }})">
                                <i id="favorite-icon" class="{% if is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                            </button>
                        {% elif not current_user.is_authenticated %}
                            <a href="{{ url_for('auth.login', next=request.path) }}" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập để mua hàng
                            </a>
                        {% endif %}
                        
                        {% if current_user.is_authenticated and current_user.id == product.seller_id %}
                            <a href="{{ url_for('products.edit', product_id=product.id) }}" class="btn btn-warning">
                                <i class="fas fa-edit me-2"></i>Chỉnh sửa
                            </a>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash me-2"></i>Xóa
                            </button>
                        {% endif %}
                    </div>
                    
                    <!-- Form liên hệ người bán -->
                    <div class="collapse message-seller-form" id="messageForm">
                        <div class="card card-body">
                            <form action="{{ url_for('messages.send', recipient_id=product.seller_id) }}" method="POST">
                                {{ message_form.hidden_tag() }}
                                <div class="mb-3">
                                    <label for="message" class="form-label">Tin nhắn</label>
                                    {{ message_form.message(class="form-control", placeholder="Nhập tin nhắn của bạn về sản phẩm này...") }}
                                </div>
                                <button type="submit" class="btn btn-primary">Gửi tin nhắn</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Thông tin người bán -->
                <div class="col-md-4 seller-info">
                    <div class="text-center mb-3">
                        <h5>Người bán</h5>
                        <img src="{{ seller.avatar_url or url_for('static', filename='img/default-avatar.png') }}" 
                             class="seller-avatar mb-2" alt="{{ seller.name }}">
                        <h6>{{ seller.name }}</h6>
                        <div class="rating">
                            {% for i in range(seller_rating|int) %}
                                <i class="fas fa-star"></i>
                            {% endfor %}
                            {% if seller_rating % 1 != 0 %}
                                <i class="fas fa-star-half-alt"></i>
                            {% endif %}
                            {% for i in range(5 - seller_rating|round|int) %}
                                <i class="far fa-star"></i>
                            {% endfor %}
                            <span>({{ seller_reviews }})</span>
                        </div>
                    </div>
                    
                    <div class="seller-stats text-center">
                        <p><i class="fas fa-box me-2"></i>{{ seller_products }} sản phẩm</p>
                        <p><i class="fas fa-clock me-2"></i>Tham gia từ {{ seller.created_at.strftime('%m/%Y') }}</p>
                        <a href="{{ url_for('profile.view', user_id=seller.id) }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-store me-1"></i>Xem cửa hàng
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mô tả sản phẩm -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Mô tả sản phẩm</h5>
                </div>
                <div class="card-body">
                    <p class="card-text white-space-pre-wrap">{{ product.description }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sản phẩm tương tự -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h4 class="mb-3"><i class="fas fa-tags me-2"></i>Sản phẩm tương tự</h4>
            <div class="row">
                {% for similar_product in similar_products %}
                    <div class="col-6 col-md-3 mb-4">
                        <div class="card similar-product">
                            <img class="card-img-top similar-img" src="{{ similar_product.images[0] }}" alt="{{ similar_product.name }}">
                            <div class="card-body">
                                <h6 class="card-title">{{ similar_product.name }}</h6>
                                <p class="text-danger fw-bold">{{ "{:,.0f}".format(similar_product.price) }} đ</p>
                                <a href="{{ url_for('products.detail', product_id=similar_product.id) }}" class="btn btn-sm btn-outline-primary">Xem chi tiết</a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xóa sản phẩm <strong>{{ product.name }}</strong> không? Hành động này không thể hoàn tác.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <form action="{{ url_for('products.delete', product_id=product.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Xác nhận xóa</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
<script>
    // Khởi tạo Fancybox
    Fancybox.bind('[data-fancybox="gallery"]', {
        // Các tùy chọn ở đây
    });
    
    // Đổi hình ảnh chính
    function changeMainImage(thumbnail) {
        const mainImage = document.getElementById('main-image');
        const mainImageLink = mainImage.parentElement;
        const newImageUrl = thumbnail.getAttribute('data-img-url');
        
        // Đổi hình ảnh chính
        mainImage.src = newImageUrl;
        mainImageLink.href = newImageUrl;
        
        // Đổi class active
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails.forEach(thumb => {
            thumb.classList.remove('active');
        });
        thumbnail.classList.add('active');
    }
    
    // Xử lý yêu thích sản phẩm
    function toggleFavorite(productId) {
        fetch(`/products/${productId}/favorite`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            const favoriteIcon = document.getElementById('favorite-icon');
            if (data.is_favorite) {
                favoriteIcon.classList.remove('far');
                favoriteIcon.classList.add('fas');
            } else {
                favoriteIcon.classList.remove('fas');
                favoriteIcon.classList.add('far');
            }
        });
    }
</script>
{% endblock %}