{% extends "base.html" %}

{% block title %}Đăng bán sản phẩm - Chợ Đồ Cũ{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/min/dropzone.min.css" rel="stylesheet">
<style>
    .dropzone {
        border: 2px dashed #0087F7;
        border-radius: 5px;
        background: #f8f9fa;
        min-height: 150px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .dropzone .dz-message {
        font-weight: 400;
        margin: 2em 0;
    }
    
    .form-label.required:after {
        content: " *";
        color: red;
    }
    
    .preview-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        margin-right: 5px;
        margin-bottom: 5px;
        border-radius: 4px;
    }
    
    .preview-container {
        display: flex;
        flex-wrap: wrap;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Đăng bán sản phẩm</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('products.create') }}" enctype="multipart/form-data" id="product-form">
                    {{ form.hidden_tag() }}
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="name" class="form-label required">Tên sản phẩm</label>
                            {{ form.name(class="form-control", placeholder="Nhập tên sản phẩm") }}
                            {% if form.name.errors %}
                                <div class="text-danger">
                                    {% for error in form.name.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="category" class="form-label required">Danh mục</label>
                            {{ form.category(class="form-select") }}
                            {% if form.category.errors %}
                                <div class="text-danger">
                                    {% for error in form.category.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="price" class="form-label required">Giá (VNĐ)</label>
                            {{ form.price(class="form-control", placeholder="Ví dụ: 500000") }}
                            {% if form.price.errors %}
                                <div class="text-danger">
                                    {% for error in form.price.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="condition" class="form-label required">Tình trạng</label>
                            {{ form.condition(class="form-select") }}
                            {% if form.condition.errors %}
                                <div class="text-danger">
                                    {% for error in form.condition.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="location" class="form-label required">Địa điểm</label>
                            {{ form.location(class="form-control", placeholder="Ví dụ: Quận 7, TP.HCM") }}
                            {% if form.location.errors %}
                                <div class="text-danger">
                                    {% for error in form.location.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label required">Mô tả chi tiết</label>
                        {{ form.description(class="form-control", rows=5, placeholder="Mô tả chi tiết về sản phẩm, tình trạng sử dụng, lý do bán...") }}
                        {% if form.description.errors %}
                            <div class="text-danger">
                                {% for error in form.description.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label required">Hình ảnh sản phẩm</label>
                        <div id="image-dropzone" class="dropzone">
                            <div class="dz-message needsclick">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                                <h5 class="text-muted">Kéo thả hoặc nhấp để tải lên hình ảnh</h5>
                                <p class="text-muted">(Tối đa 5 hình, mỗi hình không quá 5MB)</p>
                            </div>
                        </div>
                        <div id="preview-container" class="preview-container"></div>
                        {{ form.images }}
                        {% if form.images.errors %}
                            <div class="text-danger">
                                {% for error in form.images.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.negotiable(class="form-check-input") }}
                        <label class="form-check-label" for="negotiable">Giá có thể thương lượng</label>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('products.list') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Hủy
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Đăng bán
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/min/dropzone.min.js"></script>
<script>
    Dropzone.autoDiscover = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Khởi tạo Dropzone
        const myDropzone = new Dropzone("#image-dropzone", {
            url: "/dummy-url", // Sẽ không sử dụng URL này vì chúng ta sẽ xử lý tải lên trong form
            autoProcessQueue: false,
            uploadMultiple: true,
            parallelUploads: 5,
            maxFiles: 5,
            maxFilesize: 5, // MB
            acceptedFiles: "image/*",
            addRemoveLinks: true,
            previewsContainer: "#preview-container",
        });
        
        // Xử lý sự kiện khi thêm file
        myDropzone.on("addedfile", function(file) {
            // Đọc file và chuyển đổi thành base64
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64String = event.target.result;
                
                // Lưu dữ liệu vào hidden input
                const imagesInput = document.querySelector('input[name="images"]');
                let images = [];
                if (imagesInput.value) {
                    images = JSON.parse(imagesInput.value);
                }
                images.push({
                    name: file.name,
                    type: file.type,
                    data: base64String
                });
                imagesInput.value = JSON.stringify(images);
            };
            reader.readAsDataURL(file);
        });
        
        // Xử lý sự kiện khi xóa file
        myDropzone.on("removedfile", function(file) {
            const imagesInput = document.querySelector('input[name="images"]');
            if (imagesInput.value) {
                let images = JSON.parse(imagesInput.value);
                images = images.filter(img => img.name !== file.name);
                imagesInput.value = JSON.stringify(images);
            }
        });
    });
</script>
{% endblock %}